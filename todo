#!/usr/local/bin/python3
# Author : Nesoy

import sqlite3 as sqlite
import sys

DATABASE_NAME = "todolist.db"
conn = sqlite.connect(DATABASE_NAME)

# SQL
GET_TODOLIST = "SELECT * FROM task WHERE status = 'TODO';"
GET_DOINGLIST = "SELECT * FROM task WHERE status = 'DOING';"
GET_DONELIST = "SELECT * FROM task WHERE status = 'DONE';"


def init():
    global conn
    with conn:
        cur = conn.cursor()
        cur.execute("CREATE TABLE IF NOT EXISTS task(id INTEGER PRIMARY KEY, status VARCHAR, description TEXT)")

# CREATE
def addTodo(param):
    global conn
    with conn:
        cur = conn.cursor()
        sql = "INSERT INTO task(status, description) values (?,?)"
        cur.execute(sql, ['TODO', param])
        conn.commit()

# READ
def getTodoList():
    return getList(GET_TODOLIST)

def getDoingList():
    return getList(GET_DOINGLIST)

def getDoneList():
    return getList(GET_DONELIST)

def getList(sql):
    global conn
    todoList = [] # empty todolist
    with conn:
        cur = conn.cursor()
        cur.execute(sql)
        for task in cur.fetchall():
            todoList.append(task)
        return todoList

# REMOVE
def removeTodo(todoList, index):
    global conn
    id = todoList[int(index)-1][0]
    with conn:
        cur = conn.cursor()
        sql = 'DELETE FROM task WHERE id=(?)'
        cur.execute(sql, [id])
        conn.commit()

# PRINT
def printAllList():
    printTodoList()
    printDoneList()

def printTodoList():
    todoList = getTodoList()
    printList("# Todo List", todoList)

def printDoneList():
    todoList = getDoneList()
    printList("# Done List", todoList)

def printList(listName, todoList):
    print(listName)
    if(len(todoList) > 0):
        index = 1
        print("   STATUS  DESC")
        for todo in todoList:
            print("[" + str(index) + "] " + todo[1] + " : " + todo[2])
            index += 1



def main(argv):
    init()
    if(argv[1] == "add"):
        addTodo(argv[2])
    if(argv[1] == "list"):
        if(len(argv) > 2):
            if(argv[2] == "all"):
                printAllList()
            if(argv[2] == "done"):
                printDoneList()
        else:
           printTodoList()

    if(argv[1] == "remove"):
        # Check argv Size
        todoList = getTodoList()
        removeTodo(todoList, argv[2])

if __name__ == "__main__":
        main(sys.argv)
